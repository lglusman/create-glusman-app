using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using WebApi.Models;
using WebApi.Models.DTOs;
using WebApi.Models.Helper;
using WebApi.Models.Entities;


namespace WebApi.Controllers
{
    [Authorize]
    [Route("api/[controller]")]
    [ApiController]
    public class $entidadplural$Controller : ControllerBase
    {

        private readonly Db$$Db$$ _context;

        public $entidadplural$Controller(DbInfraestructura context)
        {
            _context = context;
        }

        // GET: api/$entidadplural$
        [HttpGet]
        public wsResponse Get$entidadplural$([FromQuery] string inc = "", [FromQuery] int cant = 0, [FromQuery] int pag = 0, [FromQuery] string orden = "")
        {
            var ws = new wsResponse();
            try
            {
                var query = _context.$entidadplural$;

                if (orden == "")
                    orden = "Id";

                QueryHelper<$entidadsingular$> qh = new(_context, query, inc, orden, pag, cant);
                ws.Data = qh.Data;

            }
            catch (Exception ex)
            {
                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }
            return ws;
        }

        // GET: api/$entidadplural$/5
        [HttpGet("{id:int}")]
        public wsResponse Get$entidadsingular$(int id, [FromQuery] string inc = "", [FromQuery] int cant = 0, [FromQuery] int pag = 0, [FromQuery] string orden = "")
        {
            var ws = new wsResponse();
            try
            {
                var query = _context.$entidadplural$.Where(x => x.Id == id);

                if (orden == "")
                    orden = "Id";

                QueryHelper<$entidadsingular$> qh = new(_context, query, inc, orden, pag, cant);
                ws.Data = qh.Data;
            }
            catch (Exception ex)
            {
                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }
            return ws;

        }

        [HttpGet("{busqueda}")]
        public wsResponse Get$entidadplural$Busqueda(string busqueda, [FromQuery] string inc = "", [FromQuery] int cant = 0, [FromQuery] int pag = 0, [FromQuery] string orden = "")
        {
            var ws = new wsResponse();
            try
            {
                if (busqueda.EndsWith("__ax"))
                {
                    var buscar = busqueda.Replace("__ax", "");
                    var query = _context.$entidadplural$.Where(x => x.$descripcion$.ToUpper().Contains(buscar));

                    if (orden == "")
                        orden = "Id";

                    QueryHelper<$entidadsingular$> qh = new(_context, query, inc, orden, pag, cant);
                    ws.Data = qh.Data;
                }
                else
                {
                    ws.ResultadoOk = false;
                    ws.Data = new Paginacion();
                    ws.Mensaje = "Busqueda erronea";
                }
            }
            catch (Exception ex)
            {
                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }
            return ws;

        }

        // PUT: api/$entidadplural$/5
        [HttpPut]
        public async Task<wsResponse> Put$entidadsingular$($entidadsingular$DTO entidadDTO)
        {
            var ws = new wsResponse();
            try
            {
                entidadDTO.validar();
                bool success = int.TryParse(HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out int iduaurio);
                if (success)
                    entidadDTO.UsuarioModificacionId = iduaurio;
                entidadDTO.FechaModificacion = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fffZ");
                var entidad = entidadDTO.ToEntity();
                _context.Entry(entidad).State = EntityState.Modified;
                _context.Entry(entidad).Property(x => x.FechaAlta).IsModified = false;
                _context.Entry(entidad).Property(x => x.UsuarioAltaId).IsModified = false;
                try
                {
                    await _context.SaveChangesAsync();
                    var lista = new List<EdificioDTO>();
                    lista.Add(entidad.ToDTO());
                    ws.Data.Data = lista;
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!$entidadsingular$Exists(entidad.Id))
                    {
                        ws.ResultadoOk = false;
                        ws.Mensaje = "NotFound";
                    }
                    else
                    {
                        throw;
                    }
                }
            }
            catch (Exception ex)
            {

                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }

            return ws;
        }

        // POST: api/$entidadplural$
        [HttpPost]
        public async Task<wsResponse> Post$entidadsingular$($entidadsingular$DTO entidadDTO)
        {
            var ws = new wsResponse();
            try
            {
                entidadDTO.FechaAlta = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fffZ");
                bool success = int.TryParse(HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out int iduaurio);
                if (success)
                    entidadDTO.UsuarioAltaId = iduaurio;
                entidadDTO.validar();
                var entidad = entidadDTO.ToEntity();
                _context.$entidadplural$.Add(entidad);
                await _context.SaveChangesAsync();
                var lista = new List<EdificioDTO>();
                lista.Add(entidad.ToDTO());
                ws.Data.Data = lista;
            }
            catch (Exception ex)
            {
                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }
            return ws;
        }

        // DELETE: api/$entidadplural$/5
        [HttpDelete("{id}")]
        public async Task<wsResponse> Delete$entidadsingular$(int id)
        {
            var ws = new wsResponse();
            try
            {
                var entidad = await _context.$entidadplural$.FindAsync(id);
                if (entidad == null)
                {
                    ws.ResultadoOk = false;
                    ws.Mensaje = "NotFound";
                }
                else
                {
                    _context.$entidadplural$.Remove(entidad);
                    await _context.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                ws.ResultadoOk = false;
                ws.Mensaje = ex.Message;
                ws.Data = new Paginacion();
            }
            return ws;
        }

        private bool $entidadsingular$Exists(int id)
        {
            return _context.$entidadplural$.Any(e => e.Id == id);
        }
    }
}

